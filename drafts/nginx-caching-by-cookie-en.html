<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Nginx caching by cookie - GM</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="http://gm.lv/favicon.png" rel="icon">

<link rel="canonical" href="http://gm.lv/drafts/nginx-caching-by-cookie-en.html">

        <meta name="author" content="Gints Murāns"/>
        <meta name="keywords" content="2010"/>
        <meta name="description" content="For one website I am working on I wanted to configure nginx so that when user is not logged in, site is taken from nginx cache, but when user is logged in, the site is loading from wordpress directly. Because of performance, of course. :) And also I had an requirement from IT Risks of my organization that wp-admin is accessible only from our network. Here is the configuration file for a virtual host: # www.domain.lv server { listen 80 default; server_name www.domain.lv; root /path_to_root; index index.php index.html; charset utf-8; error_page 404 /index.php; access_log /path_to_log_file; location ~ (/\.ht) { return 404; } location / { if (-f $request_filename) { expires 30d; break; } try_files $uri $uri/ /index.php; } location ~ ^/__cached/.+\.php$ { if ($uri ~ ^/__cached/(.+\.php)$) { set $path /$1; } fastcgi_cache NAME; fastcgi_cache_valid any 5m; fastcgi_cache_key $document_root$request_uri; fastcgi_cache_use_stale error timeout invalid_header http_500; fastcgi_ignore_headers Cache-Control Expires; fastcgi_pass 127.0.0.1:9000; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root/$path; fastcgi_split_path_info ^(.+\.php)(.*)$; include fastcgi_params; } location ~ (wp-(admin/.*|login|register)\.php$) { if ($remote_addr !~ xxx\.x\.xx\..+|xxx\.x\.xx\..+|xxx\.xxx\.xxx\..+){ return 404; } if (!-f $request_filename …"/>

        <meta property="og:site_name" content="GM"/>
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Nginx caching by cookie"/>
        <meta property="og:url" content="http://gm.lv/drafts/nginx-caching-by-cookie-en.html"/>
        <meta property="og:description" content="For one website I am working on I wanted to configure nginx so that when user is not logged in, site is taken from nginx cache, but when user is logged in, the site is loading from wordpress directly. Because of performance, of course. :) And also I had an requirement from IT Risks of my organization that wp-admin is accessible only from our network. Here is the configuration file for a virtual host: # www.domain.lv server { listen 80 default; server_name www.domain.lv; root /path_to_root; index index.php index.html; charset utf-8; error_page 404 /index.php; access_log /path_to_log_file; location ~ (/\.ht) { return 404; } location / { if (-f $request_filename) { expires 30d; break; } try_files $uri $uri/ /index.php; } location ~ ^/__cached/.+\.php$ { if ($uri ~ ^/__cached/(.+\.php)$) { set $path /$1; } fastcgi_cache NAME; fastcgi_cache_valid any 5m; fastcgi_cache_key $document_root$request_uri; fastcgi_cache_use_stale error timeout invalid_header http_500; fastcgi_ignore_headers Cache-Control Expires; fastcgi_pass 127.0.0.1:9000; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root/$path; fastcgi_split_path_info ^(.+\.php)(.*)$; include fastcgi_params; } location ~ (wp-(admin/.*|login|register)\.php$) { if ($remote_addr !~ xxx\.x\.xx\..+|xxx\.x\.xx\..+|xxx\.xxx\.xxx\..+){ return 404; } if (!-f $request_filename …"/>
        <meta property="article:published_time" content="2010-10-05"/>
            <meta property="article:section" content="Sākums"/>
            <meta property="article:tag" content="2010"/>
            <meta property="article:author" content="Gints Murāns"/>


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://gm.lv/theme/css/bootstrap.united.min.css" type="text/css"/>
    <link href="http://gm.lv/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://gm.lv/theme/css/pygments/solarizeddark.css" rel="stylesheet">
    <link rel="stylesheet" href="http://gm.lv/theme/css/style.css" type="text/css"/>

        <link href="http://gm.lv/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="GM ATOM Feed"/>

        <link href="http://gm.lv/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="GM RSS Feed"/>


        <link href="http://gm.lv/feeds/category_sakums.atom.xml" type="application/atom+xml" rel="alternate"
              title="GM Sākums ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <a href="http://gm.lv/" class="navbar-brand">
GM            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://gm.lv/pages/dzivokla-remonts.html">
                             Dzīvokļa remonts
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li class="active"><a href="http://gm.lv/">lv</a></li>
                <li><a href="http://gm.lv/en/">en</a></li>

            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://gm.lv/drafts/nginx-caching-by-cookie-en.html"
                       rel="bookmark"
                       title="Permalink to Nginx caching by cookie">
                        Nginx caching by cookie
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2010-10-05T06:18:00+03:00"> Tue 05 October 2010</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="http://gm.lv/tag/2010.html">2010</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>For one website I am working on I wanted to configure nginx so that when user is not logged in, site is taken from nginx cache, but when user is logged in, the site is loading from wordpress directly. Because of performance, of course. :) And also I had an requirement from IT Risks of my organization that wp-admin is accessible only from our network.</p>
<p>Here is the configuration file for a virtual host:</p>
<div class="highlight"><pre><span></span><code>  <span class="err">#</span> <span class="nt">www</span><span class="p">.</span><span class="nc">domain</span><span class="p">.</span><span class="nc">lv</span>
<span class="nt">server</span> <span class="p">{</span>
    <span class="err">listen</span>       <span class="err">80</span> <span class="err">default</span><span class="p">;</span>
    <span class="err">server_name</span>  <span class="err">www.domain.lv</span><span class="p">;</span>

    <span class="err">root</span> <span class="err">/path_to_root</span><span class="p">;</span>
    <span class="err">index</span> <span class="err">index.php</span> <span class="err">index.html</span><span class="p">;</span>

    <span class="err">charset</span> <span class="err">utf-8</span><span class="p">;</span>
    <span class="err">error_page</span>  <span class="err">404</span> <span class="err">/index.php</span><span class="p">;</span>
    <span class="err">access_log</span>  <span class="err">/path_to_log_file</span><span class="p">;</span>


    <span class="err">location</span> <span class="err">~</span> <span class="err">(/\.ht)</span> <span class="err">{</span>
        <span class="err">return</span> <span class="err">404</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nt">location</span> <span class="o">/</span> <span class="p">{</span>
      <span class="err">if</span> <span class="err">(-f</span> <span class="err">$request_filename)</span> <span class="err">{</span>
        <span class="err">expires</span> <span class="err">30d</span><span class="p">;</span>
        <span class="err">break</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nt">try_files</span> <span class="o">$</span><span class="nt">uri</span> <span class="o">$</span><span class="nt">uri</span><span class="o">/</span> <span class="o">/</span><span class="nt">index</span><span class="p">.</span><span class="nc">php</span><span class="o">;</span>
    <span class="err">}</span>


    <span class="nt">location</span> <span class="o">~</span> <span class="o">^/</span><span class="nt">__cached</span><span class="o">/.+</span><span class="err">\</span><span class="p">.</span><span class="nc">php</span><span class="o">$</span> <span class="p">{</span>
        <span class="err">if</span> <span class="err">($uri</span> <span class="err">~</span> <span class="err">^/__cached/(.+\.php)$)</span>
        <span class="err">{</span>
            <span class="err">set</span> <span class="err">$path</span> <span class="err">/$1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nt">fastcgi_cache</span> <span class="nt">NAME</span><span class="o">;</span>
        <span class="nt">fastcgi_cache_valid</span> <span class="nt">any</span> <span class="nt">5m</span><span class="o">;</span>
        <span class="nt">fastcgi_cache_key</span> <span class="o">$</span><span class="nt">document_root</span><span class="o">$</span><span class="nt">request_uri</span><span class="o">;</span>
        <span class="nt">fastcgi_cache_use_stale</span> <span class="nt">error</span> <span class="nt">timeout</span> <span class="nt">invalid_header</span> <span class="nt">http_500</span><span class="o">;</span>
        <span class="nt">fastcgi_ignore_headers</span>  <span class="nt">Cache-Control</span>  <span class="nt">Expires</span><span class="o">;</span>

        <span class="nt">fastcgi_pass</span>   <span class="nt">127</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">1</span><span class="p">:</span><span class="nd">9000</span><span class="o">;</span>
        <span class="nt">fastcgi_index</span>  <span class="nt">index</span><span class="p">.</span><span class="nc">php</span><span class="o">;</span>
        <span class="nt">fastcgi_param</span>  <span class="nt">SCRIPT_FILENAME</span>  <span class="o">$</span><span class="nt">document_root</span><span class="o">/$</span><span class="nt">path</span><span class="o">;</span>
        <span class="nt">fastcgi_split_path_info</span> <span class="o">^(.+</span><span class="err">\</span><span class="p">.</span><span class="nc">php</span><span class="o">)(.*)$;</span>
        <span class="nt">include</span>        <span class="nt">fastcgi_params</span><span class="o">;</span>
    <span class="err">}</span>


    <span class="nt">location</span> <span class="o">~</span> <span class="o">(</span><span class="nt">wp-</span><span class="o">(</span><span class="nt">admin</span><span class="o">/.*|</span><span class="nt">login</span><span class="o">|</span><span class="nt">register</span><span class="o">)</span><span class="err">\</span><span class="p">.</span><span class="nc">php</span><span class="o">$)</span> <span class="p">{</span>
        <span class="err">if</span> <span class="err">($remote_addr</span> <span class="err">!~</span> <span class="err">xxx\.x\.xx\..+|xxx\.x\.xx\..+|xxx\.xxx\.xxx\..+){</span>
            <span class="err">return</span> <span class="err">404</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nt">if</span> <span class="o">(!</span><span class="nt">-f</span> <span class="o">$</span><span class="nt">request_filename</span><span class="o">)</span> <span class="p">{</span>
            <span class="err">return</span> <span class="err">404</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nt">fastcgi_pass</span>   <span class="nt">127</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">1</span><span class="p">:</span><span class="nd">9000</span><span class="o">;</span>
        <span class="nt">fastcgi_index</span>  <span class="nt">index</span><span class="p">.</span><span class="nc">php</span><span class="o">;</span>
        <span class="nt">fastcgi_param</span>  <span class="nt">SCRIPT_FILENAME</span>  <span class="o">$</span><span class="nt">document_root</span><span class="o">$</span><span class="nt">fastcgi_script_name</span><span class="o">;</span>
        <span class="nt">include</span>        <span class="nt">fastcgi_params</span><span class="o">;</span>
    <span class="err">}</span>


    <span class="nt">location</span> <span class="o">~</span> <span class="err">\</span><span class="p">.</span><span class="nc">php</span><span class="o">$</span> <span class="p">{</span>
        <span class="err">if</span> <span class="err">(!-f</span> <span class="err">$request_filename)</span> <span class="err">{</span>
            <span class="err">return</span> <span class="err">404</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nt">if</span> <span class="o">($</span><span class="nt">http_cookie</span> <span class="o">!~</span> <span class="s2">&quot;wordpress_logged_in_.+&quot;</span><span class="o">)</span>
        <span class="p">{</span>
            <span class="err">rewrite</span> <span class="err">(.+)</span> <span class="err">/__cached$1</span> <span class="err">last</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nt">fastcgi_pass</span>   <span class="nt">127</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">1</span><span class="p">:</span><span class="nd">9000</span><span class="o">;</span>
        <span class="nt">fastcgi_index</span>  <span class="nt">index</span><span class="p">.</span><span class="nc">php</span><span class="o">;</span>
        <span class="nt">fastcgi_param</span>  <span class="nt">SCRIPT_FILENAME</span>  <span class="o">$</span><span class="nt">document_root</span><span class="o">$</span><span class="nt">fastcgi_script_name</span><span class="o">;</span>
        <span class="nt">fastcgi_split_path_info</span> <span class="o">^(.+</span><span class="err">\</span><span class="p">.</span><span class="nc">php</span><span class="o">)(.*)$;</span>
        <span class="nt">include</span>        <span class="nt">fastcgi_params</span><span class="o">;</span>
    <span class="err">}</span>
<span class="err">}</span>
</code></pre></div>

<p>Now what we have here?</p>
<p>When request to php file come in “location ~ .php$” handles it. If it sees that there is no cookie with a name “wordpress_logged_in_.+” it makes internal redirect to this location: “location ~ ^/<strong>cached/.+.php$ {” which cuts off the “</strong>cached” directory and loads the script from the cache.</p>
<p>To achieve IT Risk policy, requests to wp-admin, wp-login.php and wp-register.php is handled by “location ~ (wp-(admin/.*|login|register).php$) {” location and ip addreses restricted by this line: “if ($remote_addr !~ xxx.x.xx..+|xxx.x.xx..+|xxx.xxx.xxx..+){ return 404; }”.</p>
<p>Now it seems to me quite easy to understand, but it took all day to get to this. I guess there could be a better solution, but for now this works for me. :)</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'dzivoklis'; // required: replace example with your forum shortname

                var disqus_url = 'http://gm.lv/drafts/nginx-caching-by-cookie-en.html';

            var disqus_config = function () {
                this.language = "lv";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://www.facebook.com/gintsmurans" target="_blank"><i class="fa fa-facebook-square fa-lg"></i> facebook</a></li>
                <li class="list-group-item"><a href="https://www.instagram.com/gintsmurans/" target="_blank"><i class="fa fa-instagram fa-lg"></i> instagram</a></li>
                <li class="list-group-item"><a href="http://github.com/gintsmurans" target="_blank"><i class="fa fa-github-square fa-lg"></i> github</a></li>
              </ul>
            </li>





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="https://laacz.lv/category/celam-maju/" target="_blank">
                Laacz ceļ māju
            </a>
        </li>
        <li class="list-group-item">
            <a href="https://gimenesmaja.wordpress.com/" target="_blank">
                Ģimenes māja
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://gimenesmaja.blogspot.com/" target="_blank">
                Ģimenes māja 2
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://vasarnica.blogspot.com/" target="_blank">
                Vasarnīca
            </a>
        </li>
        <li class="list-group-item">
            <a href="https://kokamaja.wordpress.com/" target="_blank">
                Koka māja
            </a>
        </li>
        <li class="list-group-item">
            <a href="https://buvejotmaju.wordpress.com/" target="_blank">
                Būvejot māju
            </a>
        </li>
        <li class="list-group-item">
            <a href="https://kirsuparks.wordpress.com/" target="_blank">
                Ķiršu parks
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://www.uzbuve.lv/" target="_blank">
                Praktisko padomu bibliotēka
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://calis.delfi.lv/forums/(tema/4014436-ko-dzivokli-un-maja-taisitu-savadak/)/" target="_blank">
                Ko darītu savādāk
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://www.varupats.lv/" target="_blank">
                Varu pats
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://gridasmeistars.lv/" target="_blank">
                Grīdas meistars
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Gints Murāns
            &middot; Powered by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>              <p><small>  <a rel="license" href="https://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>, except where indicated otherwise.
</small></p>

         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://gm.lv/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://gm.lv/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://gm.lv/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'dzivoklis'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
<script async defer data-domain="gm.lv" src="https://tr.4apps.lv/js/plausible.js"></script>
</body>
</html>